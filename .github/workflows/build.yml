name: Build installers

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.setsha.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Bump version
        id: bump
        if: github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[skip ci]')
        run: |
          node scripts/bump-version.mjs
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
          git commit -m "chore: bump version [skip ci]"
          git push
      - name: Set sha output
        id: setsha
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build:
    needs: bump
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump.outputs.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install
        run: npm ci

      - name: Install Windows bundler (WiX)
        if: startsWith(matrix.os, 'windows')
        run: choco install wixtoolset -y

      - name: Build Tauri (Windows MSI)
        if: startsWith(matrix.os, 'windows')
        run: npm run tauri:build -- --bundles msi

      - name: Inspect bundle output
        shell: powershell
        run: |
          Write-Host "== src-tauri/target/release =="
          Get-ChildItem -Force -ErrorAction SilentlyContinue "src-tauri/target/release"
          Write-Host "== src-tauri/target/release/bundle =="
          Get-ChildItem -Force -ErrorAction SilentlyContinue "src-tauri/target/release/bundle"

      - name: Collect bundles
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          $msi = Get-ChildItem -Path "src-tauri/target/release/bundle/msi" -Filter "*.msi" -ErrorAction SilentlyContinue
          $exe = Get-ChildItem -Path "src-tauri/target/release" -Filter "*.exe" -ErrorAction SilentlyContinue
          if ($msi) { $msi | Copy-Item -Destination artifacts -Force }
          if ($exe) { $exe | Copy-Item -Destination artifacts -Force }
          $count = (Get-ChildItem -Path artifacts -ErrorAction SilentlyContinue | Measure-Object).Count
          if ($count -eq 0) {
            Write-Error "No Windows installer (.msi) or app (.exe) found in build output."
            exit 1
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.os }}
          path: artifacts/**
          if-no-files-found: error
