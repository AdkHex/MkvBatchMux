name: Build and bump version

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.setsha.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Bump version
        id: bump
        if: github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[skip ci]')
        run: |
          node scripts/bump-version.mjs
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
          git commit -m "chore: bump version [skip ci]"
          git push
      - name: Set sha output
        id: setsha
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build:
    needs: bump
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump.outputs.sha }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux deps
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install
        run: npm ci

      - name: Install Windows bundler (WiX)
        if: startsWith(matrix.os, 'windows')
        run: choco install wixtoolset -y

      - name: Build Tauri (Windows MSI)
        if: startsWith(matrix.os, 'windows')
        run: npm run tauri:build -- --bundles msi

      - name: Build Tauri (macOS DMG)
        if: startsWith(matrix.os, 'macos')
        run: npm run tauri:build -- --bundles dmg

      - name: Build Tauri (Linux bundles)
        if: startsWith(matrix.os, 'ubuntu')
        run: npm run tauri:build -- --bundles deb,appimage

      - name: Inspect bundle output
        shell: bash
        run: |
          echo "== src-tauri/target/release =="
          ls -la src-tauri/target/release || true
          echo "== src-tauri/target/release/bundle =="
          ls -la src-tauri/target/release/bundle || true

      - name: Collect bundles
        shell: bash
        run: |
          mkdir -p artifacts
          if [ -d "src-tauri/target" ]; then
            find src-tauri/target -type f \( -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" \) -print -exec cp -v "{}" artifacts/ \;
          fi
          if [ -z "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "No bundle files found (.msi/.dmg/.deb/.AppImage)."
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.os }}
          path: artifacts/**
          if-no-files-found: error
